<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Refactor Blog: (2) SSR | Asuka Wang</title><meta name="description" content="Asuka Wang&#x27;s blog"/><meta property="og:title" content="Refactor Blog: (2) SSR | Asuka Wang"/><meta property="twitter:title" content="Refactor Blog: (2) SSR | Asuka Wang"/><meta name="next-head-count" content="6"/><link rel="preconnect" href="/" crossorigin="anonymous"/><script id="theme-document" data-nscript="beforeInteractive">
        if (typeof window !== "undefined") {
          const savedTheme = localStorage.getItem("ASUKACHIKARU_THEME");
          const html = document.documentElement;
          const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches
            ? 'DARK'
            : 'LIGHT';
          if (savedTheme === "DARK" || systemTheme === "DARK") {
            html.classList.add('dark');
            html.style.backgroundColor = "#27211F";
          } else {
            html.classList.remove('dark');
            html.style.backgroundColor = "#F5F2E8";
          }
        }
      </script><link rel="preload" href="/_next/static/css/bc84e5645459944b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/bc84e5645459944b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/d8403707d10b0477.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d8403707d10b0477.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-b8f8d6679aaa5f42.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-f2ca60db2beb93ed.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d9a3b6ece2864e53.js" defer=""></script><script src="/_next/static/chunks/970-e8ce68274b194f36.js" defer=""></script><script src="/_next/static/chunks/986-0be399a925af549c.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bpathname%5D-b31eb8cafbf70561.js" defer=""></script><script src="/_next/static/DprFBLrygr1bgHJ6nxl5c/_buildManifest.js" defer=""></script><script src="/_next/static/DprFBLrygr1bgHJ6nxl5c/_ssgManifest.js" defer=""></script></head><body><div id="__next"><main class="__variable_ef4fb7 __variable_88a4a7 __variable_23fcf6 __variable_9d551b __variable_6fb08b __variable_4de8ae"><div class="text-color"><div class="mx-fb2 lg:mx-auto max-w-[1280px]"><div class="mt-fb1 lg:mt-fb2"><div class="flex justify-end"><button class="font-noto-sans text-fb2 interactive-color">light mode</button></div><div class="flex justify-between w-full mt-fb8 mb-fb2"><div class="w-fit flex flex-col lg:flex-row gap-fb1 lg:gap-fb3"><a class="text-fb2 font-serif lg:text-fb3 leading-fb3 lg:leading-fb5 interactive-color text-color" href="/blog/">BLOG</a><a class="text-fb2 font-serif lg:text-fb3 leading-fb3 lg:leading-fb5 interactive-color " href="/about/">ABOUT</a></div><a class="text-fb3 lg:text-fb5 leading-none font-abhaya-libre font-bold" href="/">ASUKA WANG</a></div><div class="mb-fb2 lg:mb-fb3 border-t-2 border-b h-2 border-color-100"></div></div><div><div class="flex flex-col gap-fb1 mb-fb5 lg:mb-fb8"><h1 class="text-fb8 lg:text-fb13 font-abril leading-none">REFACTOR BLOG: (2) SSR</h1><div class="text-fb2 lg:text-fb3 font-noto-sans">March 26, 2021</div></div><div class="w-full grid grid-cols-4 gap-fb3"><div class="col-span-4 lg:col-span-3"><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>One of the reasons I choose Gatsby last time I wrote my blog site is to have SSR. SEO matters, isn&#x27;t it?</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>I gained experience setting up SSR in my job, and this is how I apply that experience in my project.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><h2 class="mt-8 text-2xl lg:text-4xl font-semibold" id="The-Idea"><span>The Idea</span></h2></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>First, let&#x27;s talk about React (and most of the MVVM frameworks) app without SSR. They are an HTML template with a js file. Everything about the app is in the js file; the HTML is merely a host for the app.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>When the user&#x27;s browser requests data of the app from the server, the HTML is provided. A blank HTML page with some metadata is rendered.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>Then the HTML requests the data of the js file from the </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">&lt;script&gt;</code><span> tag. The js file is fetched then executed. The logic inside starts working. Then the app is created and attached to a specific HTML element.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>The problem is that search engines can&#x27;t observe the actual app in the first render. Therefore, for the search engines, the app is always a blank page.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>The solution is SSR -- server-side rendering. When the app is requested, the server runs the app, prints them into strings, then sends them with the HTML. For the browsers or the search engines, they get the whole app in the first render.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><h2 class="mt-8 text-2xl lg:text-4xl font-semibold" id="Dependencies"><span>Dependencies</span></h2></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><ul class="list-disc list-inside mx-8"><li><a href="http://expressjs.com/" class="text-blue-400 underline" rel="noreferrer noopener" target="_blank">express</a><span> for handling requests and responses</span></li></ul></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><h2 class="mt-8 text-2xl lg:text-4xl font-semibold" id="Setting-up-the-server"><span>Setting up the server</span></h2></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>Receive requests and send HTML. The HTML will be a string instead of a file for inserting stringified app.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><pre class="my-6 border rounded-md text-base leading-4"><code class="font-courier language-ts rounded-md">import * as Express from &quot;express&quot;;

const APP_PORT = process.env.PORT || 3000;
const app = Express();
const renderer = () =&gt; {
	app.get(&quot;*&quot;, (req: Express.Request, res: Express.Response) =&gt; {
		res.send(`
			&lt;!DOCTYPE HTML&gt;
			&lt;html&gt;
				&lt;head&gt;
					&lt;!-- insert metadata here --&gt;
				&lt;/head&gt;
				&lt;body&gt;
					&lt;div id=&quot;app-root&quot;&gt;&lt;/div&gt;
				&lt;/body&gt;
			&lt;/html&gt;
		`);
	});
};

app.use(renderer);
app.listen(APP_PORT, () =&gt; {
	console.log(`Server is listening on ${APP_PORT}`);
});</code></pre></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><h2 class="mt-8 text-2xl lg:text-4xl font-semibold" id="Library-setups"><span>Library setups</span></h2></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>I&#x27;m only using the major libraries for this app. Fortunately, some of them provide APIs for SSR setup. The common idea of libraries&#x27; SSR setup is getting the stringified part of each library from their API, then passing them into the HTML template.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><h3 class="mt-8 text-xl lg:text-3xl font-semibold" id="React"><span>React</span></h3></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><a href="https://reactjs.org/docs/react-dom-server.html#gatsby-focus-wrapper" class="text-blue-400 underline" rel="noreferrer noopener" target="_blank">Document</a></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>React&#x27;s API for SSR is </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">ReactDOMServer.renderToString(element)</code><span>. Pass the app in JSX format as the element parameter.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><pre class="my-6 border rounded-md text-base leading-4"><code class="font-courier language-ts rounded-md">import * as React from &quot;react&quot;;
import * as ReactDOMServer from &quot;react-dom/server&quot;;

import { App } from &quot;../client/App&quot;;

let htmlBody;

try {
	htmlBody = ReactDOMServer.renderToString(&lt;App /&gt;);
} catch(error) {
	console.error(error);
}</code></pre></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><h3 class="mt-8 text-xl lg:text-3xl font-semibold" id="React-Helmet"><span>React Helmet</span></h3></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><a href="https://github.com/nfl/react-helmet#server-usage" class="text-blue-400 underline" rel="noreferrer noopener" target="_blank">Document</a></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>Helmet&#x27;s API for SSR is </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">Helmet.renderStatic()</code><span>. You have to call it after </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">ReactDOMServer.renderToString</code><span>.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><pre class="my-6 border rounded-md text-base leading-4"><code class="font-courier language-ts rounded-md">import { Helmet } from &quot;react-helmet&quot;;

let htmlBody;
let helmet;

try {
	htmlBody = ReactDOMServer.renderToString(&lt;App /&gt;);
	helmet = Helmet.renderStatic();
} catch(error) {
	console.error(error);
}</code></pre></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><h3 class="mt-8 text-xl lg:text-3xl font-semibold" id="React-Router-DOM"><span>React Router DOM</span></h3></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><a href="https://reactrouter.com/web/guides/server-rendering" class="text-blue-400 underline" rel="noreferrer noopener" target="_blank">Document</a></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>Wrap the app with a </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">StaticRouter</code><span>.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><pre class="my-6 border rounded-md text-base leading-4"><code class="font-courier language-ts rounded-md">import { StaticRouter } from &quot;react-router-dom&quot;;

let htmlBody;
let context;

app.get(&quot;*&quot;, (req: Express.Request, res: Express.Response) =&gt; {
	try {
		htmlBody = ReactDOMServer.renderToString(
			&lt;StaticRouter location={req.url} context={context}&gt;
				&lt;App /&gt;
			&lt;/StaticRouter&gt;
		);
	} catch(error) {
		console.error(error);
	}
};</code></pre></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><h3 class="mt-8 text-xl lg:text-3xl font-semibold" id="styled-components"><span>styled-components</span></h3></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><a href="https://styled-components.com/docs/advanced#server-side-rendering" class="text-blue-400 underline" rel="noreferrer noopener" target="_blank">Document</a></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>Use </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">sheet.collectStyles</code><span> to wrap the app, then use </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">sheet.getStyleTags</code><span> to collect all of the app&#x27;s styles.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>Finally, pass the styles into the HTML&#x27;s head.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><pre class="my-6 border rounded-md text-base leading-4"><code class="font-courier language-ts rounded-md">import { ServerStyleSheet } from &quot;styled-components&quot;;

const sheet = new ServerStyleSheet();
let htmlBody = &quot;&quot;;
let styleTags = &quot;&quot;;

try {
	htmlBody = ReactDOMServer.renderToString(
		sheet.collectStyles(
			&lt;App /&gt;
		)
	);
	styleTags = sheet.getStyleTags();
} catch (error) {
	console.error(error);
} finally {
	sheet.seal();
}</code></pre></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><h3 class="mt-8 text-xl lg:text-3xl font-semibold" id="Redux"><span>Redux</span></h3></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><a href="https://redux.js.org/recipes/server-rendering" class="text-blue-400 underline" rel="noreferrer noopener" target="_blank">Document</a></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>Redux&#x27;s SSR setup is the most complex one. The contents of the store have to be prepared and passed to the HTML during the request.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>The way to prepare the store is different for each application. For my blog, I fetch the post or the post list data for the respective request URL, then convert the data to the store type.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>Once the store is prepared, wrap the app with a </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">Provider</code><span>, and get the </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">initialState</code><span> with the API Redux provided.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><pre class="my-6 border rounded-md text-base leading-4"><code class="font-courier language-ts rounded-md">import { createStore } from &quot;redux&quot;;
import { Provider } from &quot;react-redux&quot;;

import { rootReducer, RootState } from &quot;../client/service/reducer&quot;;

app.get(&quot;*&quot;, (req: Express.Request, res: Express.Response) =&gt; {
	// pass request because store is likely dependent on request URL
	const yourStore = yourStoreInitiator(req);
	const preloadedStore: RootState = {
		// your store state
	};
	
	let htmlBody = &quot;&quot;;
	const store = createStore(rootReducer, preloadedState);
	
	try {
		htmlBody = ReactDOMServer.renderToString(
			&lt;Provider store={store}&gt;
				&lt;App /&gt;
			&lt;/Provider&gt;
		);
	} catch (error) {
		console.error(error);
	}
	
	// store.getState() returns object so we have to manually stringify it
	const initialState = JSON.stringify(store.getState());
};</code></pre></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><h3 class="mt-8 text-xl lg:text-3xl font-semibold" id="HTML-handler"><span>HTML handler</span></h3></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>Since the HTML is frequently edited with several library parts, an isolated handler makes it easier.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><pre class="my-6 border rounded-md text-base leading-4"><code class="font-courier language-ts rounded-md">const getFullHTML = (
  htmlBody: string,
  styleTags: string,
  initialState: string,
  helmet?: HelmetData
) =&gt; {
  return `
    &lt;!DOCTYPE html&gt;
    &lt;html ${helmet?.htmlAttributes.toString()}&gt;
      &lt;head&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
        ${styleTags}
        ${helmet?.title.toString()}
        ${helmet?.meta.toString()}
        ${helmet?.link.toString()}
        &lt;style&gt;
          @import url(&#x27;&lt;https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700;900&amp;display=swap&gt;&#x27;);
          @import url(&#x27;&lt;https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;400&amp;display=swap&gt;&#x27;);
        &lt;/style&gt;
      &lt;/head&gt;
      &lt;body ${helmet?.bodyAttributes.toString()}&gt;
        &lt;div id=&quot;app-root&quot;&gt;${htmlBody}&lt;/div&gt;
        &lt;script&gt;window.__INITIAL_STATE__ = ${initialState}&lt;/script&gt;
        &lt;script defer src=&quot;main.bundle.js&quot; type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
        &lt;script defer src=&quot;vendor.bundle.js&quot; type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
      &lt;/body&gt;
    &lt;/html&gt;
  `;
};</code></pre></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><h3 class="mt-8 text-xl lg:text-3xl font-semibold" id="Combine-each-part"><span>Combine each part</span></h3></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>Finally, combine all of the setups above.</span></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><pre class="my-6 border rounded-md text-base leading-4"><code class="font-courier language-ts rounded-md">import * as Express from &quot;express&quot;;
import * as React from &quot;react&quot;;
import * as ReactDOMServer from &quot;react-dom/server&quot;;
import { Helmet, HelmetData } from &quot;react-helmet&quot;;
import { Provider } from &quot;react-redux&quot;;
import { StaticRouter } from &quot;react-router-dom&quot;;
import { createStore } from &quot;redux&quot;;
import { ServerStyleSheet } from &quot;styled-components&quot;;

import { App } from &quot;../client/App&quot;;
import { rootReducer, RootState } from &quot;../client/service/reducer&quot;;

export const renderer = (
	req: Express.Request,
	res: Express.Response,
	next: Express.NextFunction,
) =&gt; {
	app.get(&quot;*&quot;, (req: Express.Request, res: Express.Response) =&gt; {
	const yourStore = yourStoreInitiator(req);
	const preloadedStore: RootState = { /* your state */ };
	
	let htmlBody = &quot;&quot;;
	const context = {};
  const sheet = new ServerStyleSheet();
  let styleTags = &quot;&quot;;
	const store = createStore(rootReducer, preloadedState);
	let helmet;
	
	try {
	  htmlBody = ReactDOMServer.renderToString(
      sheet.collectStyles(
        &lt;Provider store={store}&gt;
	        &lt;StaticRouter location={req.url} context={context}&gt;
            &lt;App /&gt;
	        &lt;/StaticRouter&gt;
        &lt;/Provider&gt;
      )
    );
    helmet = Helmet.renderStatic();
    styleTags = sheet.getStyleTags();
  } catch (error) {
    console.error(error);
  } finally {
    sheet.seal();
  }
  const initialState = JSON.stringify(store.getState());

  const fullHTML = getFullHTML(htmlBody, styleTags, initialState, helmet);
	res.send(fullHTML);
};</code></pre></div><div class="mb-6 font-serif text-lg lg:text-xl lg:leading-8 last:mb-0"><span>You can use </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">curl -X GET localhost:3000</code><span> to check if the express server is returning the whole app in the first easily.</span></div></div><div class="flex-col justify-between hidden lg:flex"><div class="flex flex-col gap-fb5"><div><div class="text-fb3 py-fb1 mb-fb3 border-t border-b border-color text-center font-noto-sans font-extralight">TABLE OF CONTENT</div><ul class="ml-fb3 list-outside list-disc interactive-list-color"><li class="mt-fb2"><a class="font-serif text-fb3 leading-none interactive-color" href="/blog/refactor-blog-2-ssr/#The-Idea">The Idea</a></li><li class="mt-fb2"><a class="font-serif text-fb3 leading-none interactive-color" href="/blog/refactor-blog-2-ssr/#Dependencies">Dependencies</a></li><li class="mt-fb2"><a class="font-serif text-fb3 leading-none interactive-color" href="/blog/refactor-blog-2-ssr/#Setting-up-the-server">Setting up the server</a></li><li class="mt-fb2"><a class="font-serif text-fb3 leading-none interactive-color" href="/blog/refactor-blog-2-ssr/#Library-setups">Library setups</a></li><li class="mt-fb2"><div class="w-fb2"></div><a class="font-serif text-fb3 leading-none interactive-color" href="/blog/refactor-blog-2-ssr/#React">React</a></li><li class="mt-fb2"><div class="w-fb2"></div><a class="font-serif text-fb3 leading-none interactive-color" href="/blog/refactor-blog-2-ssr/#React-Helmet">React Helmet</a></li><li class="mt-fb2"><div class="w-fb2"></div><a class="font-serif text-fb3 leading-none interactive-color" href="/blog/refactor-blog-2-ssr/#React-Router-DOM">React Router DOM</a></li><li class="mt-fb2"><div class="w-fb2"></div><a class="font-serif text-fb3 leading-none interactive-color" href="/blog/refactor-blog-2-ssr/#styled-components">styled-components</a></li><li class="mt-fb2"><div class="w-fb2"></div><a class="font-serif text-fb3 leading-none interactive-color" href="/blog/refactor-blog-2-ssr/#Redux">Redux</a></li><li class="mt-fb2"><div class="w-fb2"></div><a class="font-serif text-fb3 leading-none interactive-color" href="/blog/refactor-blog-2-ssr/#HTML-handler">HTML handler</a></li><li class="mt-fb2"><div class="w-fb2"></div><a class="font-serif text-fb3 leading-none interactive-color" href="/blog/refactor-blog-2-ssr/#Combine-each-part">Combine each part</a></li></ul></div><div><div class="text-fb3 py-fb1 mb-fb3 border-t border-b border-color text-center font-noto-sans font-extralight">ARCHIVE</div><div class="flex flex-col gap-fb3"><a class=" flex flex-col gap-fb1 interactive-color pb-fb2 border-b border-color last-of-type:border-none last-of-type:pb-0 lg:pb-0 lg:border-none " href="/blog/a-peek-of-the-world/"><div class="text-fb5 lg:text-fb3 font-abril leading-none text-wrap-balance">A Peek of the World</div><div class="text-fb3 lg:text-fb3 font-gentium-basic leading-none">I went to Copenhagen and London for my honeymoon, the first trip to Europe in my life. Some memories keep staying on my mind and I have many thoughts about them.</div><div class="text-fb2 leading-none font-noto-sans">June 16, 2024</div></a><a class=" flex flex-col gap-fb1 interactive-color pb-fb2 border-b border-color last-of-type:border-none last-of-type:pb-0 lg:pb-0 lg:border-none " href="/blog/godot-essentials/"><div class="text-fb5 lg:text-fb3 font-abril leading-none text-wrap-balance">Godot Essentials</div><div class="text-fb3 lg:text-fb3 font-gentium-basic leading-none">The biggest lessons I learned in my first Godot project.</div><div class="text-fb2 leading-none font-noto-sans">April 21, 2024</div></a><a class=" flex flex-col gap-fb1 interactive-color pb-fb2 border-b border-color last-of-type:border-none last-of-type:pb-0 lg:pb-0 lg:border-none " href="/blog/4-years-reflection/"><div class="text-fb5 lg:text-fb3 font-abril leading-none text-wrap-balance">4 Years Reflection</div><div class="text-fb3 lg:text-fb3 font-gentium-basic leading-none">Another two years of life as a full-time developer has passed. Many things changed and many lessons learned. It&#x27;s a perfect timing to look back and reflect.</div><div class="text-fb2 leading-none font-noto-sans">April 8, 2024</div></a><a class=" flex flex-col gap-fb1 interactive-color pb-fb2 border-b border-color last-of-type:border-none last-of-type:pb-0 lg:pb-0 lg:border-none " href="/blog/improving-greatness/"><div class="text-fb5 lg:text-fb3 font-abril leading-none text-wrap-balance">Improving Greatness</div><div class="text-fb3 lg:text-fb3 font-gentium-basic leading-none">Breath of the Wild is one of the most impactful game in last decade. Yet for its successor, Nintendo built an even more polished version on an already magnificent fundamental.</div><div class="text-fb2 leading-none font-noto-sans">March 17, 2024</div></a><a class=" flex flex-col gap-fb1 interactive-color pb-fb2 border-b border-color last-of-type:border-none last-of-type:pb-0 lg:pb-0 lg:border-none " href="/blog/s13-recap/"><div class="text-fb5 lg:text-fb3 font-abril leading-none text-wrap-balance">S13 Recap</div><div class="text-fb3 lg:text-fb3 font-gentium-basic leading-none">After a three years gap, I&#x27;m back to league.</div><div class="text-fb2 leading-none font-noto-sans">January 23, 2024</div></a><div><a class="flex items-end lg:justify-end" href="/blog/archive/"><span class="font-noto-sans text-fb3 leading-none interactive-color">FULL LIST</span></a></div></div></div><div><div class="text-fb3 py-fb1 mb-fb3 border-t border-b border-color text-center font-noto-sans font-extralight">CATEGORY</div><div class="flex flex-col gap-fb2 lg:border-l-2 border-color lg:pl-fb2"><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Gaming"><span class="text-fb3 font-alegreya">Gaming</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">12</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=League%20of%20Legends"><span class="text-fb3 font-alegreya">League of Legends</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">8</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Life"><span class="text-fb3 font-alegreya">Life</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">6</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Game%20Development"><span class="text-fb3 font-alegreya">Game Development</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">5</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Meta"><span class="text-fb3 font-alegreya">Meta</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">4</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Web%20Development"><span class="text-fb3 font-alegreya">Web Development</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">4</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=HKT48"><span class="text-fb3 font-alegreya">HKT48</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">4</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Programming"><span class="text-fb3 font-alegreya">Programming</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">3</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Movie"><span class="text-fb3 font-alegreya">Movie</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">2</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div></div></div></div><div class="self-end mt-fb5"><button class="font-noto-sans text-fb3 interactive-color">TOP</button></div></div><div class="lg:hidden col-span-4 flex flex-col gap-fb3"><div class="mt-fb5 mb-fb2 border border-color"></div><div class="px-fb2"><div class="flex gap-fb2 mb-fb1"><div class="flex-grow my-auto border-t border-b border-color h-[3px]"></div><div class="font-noto-sans text-fb2 font-thin">ARCHIVE</div><div class="flex-grow my-auto border-t border-b border-color h-[3px]"></div></div><div class="flex flex-col gap-fb3"><a class=" flex flex-col gap-fb1 interactive-color pb-fb2 border-b border-color last-of-type:border-none last-of-type:pb-0 lg:pb-0 lg:border-none " href="/blog/a-peek-of-the-world/"><div class="text-fb5 lg:text-fb3 font-abril leading-none text-wrap-balance">A Peek of the World</div><div class="text-fb3 lg:text-fb3 font-gentium-basic leading-none">I went to Copenhagen and London for my honeymoon, the first trip to Europe in my life. Some memories keep staying on my mind and I have many thoughts about them.</div><div class="text-fb2 leading-none font-noto-sans">June 16, 2024</div></a><a class=" flex flex-col gap-fb1 interactive-color pb-fb2 border-b border-color last-of-type:border-none last-of-type:pb-0 lg:pb-0 lg:border-none " href="/blog/godot-essentials/"><div class="text-fb5 lg:text-fb3 font-abril leading-none text-wrap-balance">Godot Essentials</div><div class="text-fb3 lg:text-fb3 font-gentium-basic leading-none">The biggest lessons I learned in my first Godot project.</div><div class="text-fb2 leading-none font-noto-sans">April 21, 2024</div></a><a class=" flex flex-col gap-fb1 interactive-color pb-fb2 border-b border-color last-of-type:border-none last-of-type:pb-0 lg:pb-0 lg:border-none " href="/blog/4-years-reflection/"><div class="text-fb5 lg:text-fb3 font-abril leading-none text-wrap-balance">4 Years Reflection</div><div class="text-fb3 lg:text-fb3 font-gentium-basic leading-none">Another two years of life as a full-time developer has passed. Many things changed and many lessons learned. It&#x27;s a perfect timing to look back and reflect.</div><div class="text-fb2 leading-none font-noto-sans">April 8, 2024</div></a><a class=" flex flex-col gap-fb1 interactive-color pb-fb2 border-b border-color last-of-type:border-none last-of-type:pb-0 lg:pb-0 lg:border-none " href="/blog/improving-greatness/"><div class="text-fb5 lg:text-fb3 font-abril leading-none text-wrap-balance">Improving Greatness</div><div class="text-fb3 lg:text-fb3 font-gentium-basic leading-none">Breath of the Wild is one of the most impactful game in last decade. Yet for its successor, Nintendo built an even more polished version on an already magnificent fundamental.</div><div class="text-fb2 leading-none font-noto-sans">March 17, 2024</div></a><a class=" flex flex-col gap-fb1 interactive-color pb-fb2 border-b border-color last-of-type:border-none last-of-type:pb-0 lg:pb-0 lg:border-none " href="/blog/s13-recap/"><div class="text-fb5 lg:text-fb3 font-abril leading-none text-wrap-balance">S13 Recap</div><div class="text-fb3 lg:text-fb3 font-gentium-basic leading-none">After a three years gap, I&#x27;m back to league.</div><div class="text-fb2 leading-none font-noto-sans">January 23, 2024</div></a><div><a class="flex items-end lg:justify-end" href="/blog/archive/"><span class="font-noto-sans text-fb3 leading-none interactive-color">FULL LIST</span></a></div></div></div><div class="px-fb2"><div class="flex gap-fb2 mb-fb1"><div class="flex-grow my-auto border-t border-b border-color h-[3px]"></div><div class="font-noto-sans text-fb2 font-thin">CATEGORY</div><div class="flex-grow my-auto border-t border-b border-color h-[3px]"></div></div><div class="flex flex-col gap-fb2 lg:border-l-2 border-color lg:pl-fb2"><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Gaming"><span class="text-fb3 font-alegreya">Gaming</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">12</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=League%20of%20Legends"><span class="text-fb3 font-alegreya">League of Legends</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">8</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Life"><span class="text-fb3 font-alegreya">Life</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">6</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Game%20Development"><span class="text-fb3 font-alegreya">Game Development</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">5</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Meta"><span class="text-fb3 font-alegreya">Meta</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">4</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Web%20Development"><span class="text-fb3 font-alegreya">Web Development</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">4</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=HKT48"><span class="text-fb3 font-alegreya">HKT48</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">4</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Programming"><span class="text-fb3 font-alegreya">Programming</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">3</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div><div><a class="flex leading-fb3 items-end interactive-color" href="/blog/archive/?category=Movie"><span class="text-fb3 font-alegreya">Movie</span><span class="mx-fb1 flex-grow border-b border-dashed border-color"></span><span class="text-fb3 font-noto-sans">2</span><span class="ml-fb1 text-fb2 font-noto-sans leading-none">POST<!-- -->S</span></a></div></div></div></div></div></div><div class="mt-fb8 pt-fb2 mb-fb8 text-center lg:text-left font-noto-sans interactive-color border-t border-color"><a href="https://asukachikaru.com" rel="noopener noreferrer" target="_blank" class="text-fb2">asukachikaru.com</a> <!-- -->2018-</div></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postContent":[{"type":"paragraph","children":[{"type":"plain","text":"One of the reasons I choose Gatsby last time I wrote my blog site is to have SSR. SEO matters, isn't it?"}]},{"type":"paragraph","children":[{"type":"plain","text":"I gained experience setting up SSR in my job, and this is how I apply that experience in my project."}]},{"type":"heading","children":[{"type":"plain","text":"The Idea"}],"depth":1},{"type":"paragraph","children":[{"type":"plain","text":"First, let's talk about React (and most of the MVVM frameworks) app without SSR. They are an HTML template with a js file. Everything about the app is in the js file; the HTML is merely a host for the app."}]},{"type":"paragraph","children":[{"type":"plain","text":"When the user's browser requests data of the app from the server, the HTML is provided. A blank HTML page with some metadata is rendered."}]},{"type":"paragraph","children":[{"type":"plain","text":"Then the HTML requests the data of the js file from the "},{"type":"inlineCode","text":"\u003cscript\u003e"},{"type":"plain","text":" tag. The js file is fetched then executed. The logic inside starts working. Then the app is created and attached to a specific HTML element."}]},{"type":"paragraph","children":[{"type":"plain","text":"The problem is that search engines can't observe the actual app in the first render. Therefore, for the search engines, the app is always a blank page."}]},{"type":"paragraph","children":[{"type":"plain","text":"The solution is SSR -- server-side rendering. When the app is requested, the server runs the app, prints them into strings, then sends them with the HTML. For the browsers or the search engines, they get the whole app in the first render."}]},{"type":"heading","children":[{"type":"plain","text":"Dependencies"}],"depth":1},{"type":"list","ordered":false,"children":[{"type":"listItem","children":[{"type":"link","text":"express","url":"http://expressjs.com/"},{"type":"plain","text":" for handling requests and responses"}]}]},{"type":"heading","children":[{"type":"plain","text":"Setting up the server"}],"depth":1},{"type":"paragraph","children":[{"type":"plain","text":"Receive requests and send HTML. The HTML will be a string instead of a file for inserting stringified app."}]},{"type":"code","lang":"ts","text":"import * as Express from \"express\";\n\nconst APP_PORT = process.env.PORT || 3000;\nconst app = Express();\nconst renderer = () =\u003e {\n\tapp.get(\"*\", (req: Express.Request, res: Express.Response) =\u003e {\n\t\tres.send(`\n\t\t\t\u003c!DOCTYPE HTML\u003e\n\t\t\t\u003chtml\u003e\n\t\t\t\t\u003chead\u003e\n\t\t\t\t\t\u003c!-- insert metadata here --\u003e\n\t\t\t\t\u003c/head\u003e\n\t\t\t\t\u003cbody\u003e\n\t\t\t\t\t\u003cdiv id=\"app-root\"\u003e\u003c/div\u003e\n\t\t\t\t\u003c/body\u003e\n\t\t\t\u003c/html\u003e\n\t\t`);\n\t});\n};\n\napp.use(renderer);\napp.listen(APP_PORT, () =\u003e {\n\tconsole.log(`Server is listening on ${APP_PORT}`);\n});"},{"type":"heading","children":[{"type":"plain","text":"Library setups"}],"depth":1},{"type":"paragraph","children":[{"type":"plain","text":"I'm only using the major libraries for this app. Fortunately, some of them provide APIs for SSR setup. The common idea of libraries' SSR setup is getting the stringified part of each library from their API, then passing them into the HTML template."}]},{"type":"heading","children":[{"type":"plain","text":"React"}],"depth":2},{"type":"paragraph","children":[{"type":"link","text":"Document","url":"https://reactjs.org/docs/react-dom-server.html#gatsby-focus-wrapper"}]},{"type":"paragraph","children":[{"type":"plain","text":"React's API for SSR is "},{"type":"inlineCode","text":"ReactDOMServer.renderToString(element)"},{"type":"plain","text":". Pass the app in JSX format as the element parameter."}]},{"type":"code","lang":"ts","text":"import * as React from \"react\";\nimport * as ReactDOMServer from \"react-dom/server\";\n\nimport { App } from \"../client/App\";\n\nlet htmlBody;\n\ntry {\n\thtmlBody = ReactDOMServer.renderToString(\u003cApp /\u003e);\n} catch(error) {\n\tconsole.error(error);\n}"},{"type":"heading","children":[{"type":"plain","text":"React Helmet"}],"depth":2},{"type":"paragraph","children":[{"type":"link","text":"Document","url":"https://github.com/nfl/react-helmet#server-usage"}]},{"type":"paragraph","children":[{"type":"plain","text":"Helmet's API for SSR is "},{"type":"inlineCode","text":"Helmet.renderStatic()"},{"type":"plain","text":". You have to call it after "},{"type":"inlineCode","text":"ReactDOMServer.renderToString"},{"type":"plain","text":"."}]},{"type":"code","lang":"ts","text":"import { Helmet } from \"react-helmet\";\n\nlet htmlBody;\nlet helmet;\n\ntry {\n\thtmlBody = ReactDOMServer.renderToString(\u003cApp /\u003e);\n\thelmet = Helmet.renderStatic();\n} catch(error) {\n\tconsole.error(error);\n}"},{"type":"heading","children":[{"type":"plain","text":"React Router DOM"}],"depth":2},{"type":"paragraph","children":[{"type":"link","text":"Document","url":"https://reactrouter.com/web/guides/server-rendering"}]},{"type":"paragraph","children":[{"type":"plain","text":"Wrap the app with a "},{"type":"inlineCode","text":"StaticRouter"},{"type":"plain","text":"."}]},{"type":"code","lang":"ts","text":"import { StaticRouter } from \"react-router-dom\";\n\nlet htmlBody;\nlet context;\n\napp.get(\"*\", (req: Express.Request, res: Express.Response) =\u003e {\n\ttry {\n\t\thtmlBody = ReactDOMServer.renderToString(\n\t\t\t\u003cStaticRouter location={req.url} context={context}\u003e\n\t\t\t\t\u003cApp /\u003e\n\t\t\t\u003c/StaticRouter\u003e\n\t\t);\n\t} catch(error) {\n\t\tconsole.error(error);\n\t}\n};"},{"type":"heading","children":[{"type":"plain","text":"styled-components"}],"depth":2},{"type":"paragraph","children":[{"type":"link","text":"Document","url":"https://styled-components.com/docs/advanced#server-side-rendering"}]},{"type":"paragraph","children":[{"type":"plain","text":"Use "},{"type":"inlineCode","text":"sheet.collectStyles"},{"type":"plain","text":" to wrap the app, then use "},{"type":"inlineCode","text":"sheet.getStyleTags"},{"type":"plain","text":" to collect all of the app's styles."}]},{"type":"paragraph","children":[{"type":"plain","text":"Finally, pass the styles into the HTML's head."}]},{"type":"code","lang":"ts","text":"import { ServerStyleSheet } from \"styled-components\";\n\nconst sheet = new ServerStyleSheet();\nlet htmlBody = \"\";\nlet styleTags = \"\";\n\ntry {\n\thtmlBody = ReactDOMServer.renderToString(\n\t\tsheet.collectStyles(\n\t\t\t\u003cApp /\u003e\n\t\t)\n\t);\n\tstyleTags = sheet.getStyleTags();\n} catch (error) {\n\tconsole.error(error);\n} finally {\n\tsheet.seal();\n}"},{"type":"heading","children":[{"type":"plain","text":"Redux"}],"depth":2},{"type":"paragraph","children":[{"type":"link","text":"Document","url":"https://redux.js.org/recipes/server-rendering"}]},{"type":"paragraph","children":[{"type":"plain","text":"Redux's SSR setup is the most complex one. The contents of the store have to be prepared and passed to the HTML during the request."}]},{"type":"paragraph","children":[{"type":"plain","text":"The way to prepare the store is different for each application. For my blog, I fetch the post or the post list data for the respective request URL, then convert the data to the store type."}]},{"type":"paragraph","children":[{"type":"plain","text":"Once the store is prepared, wrap the app with a "},{"type":"inlineCode","text":"Provider"},{"type":"plain","text":", and get the "},{"type":"inlineCode","text":"initialState"},{"type":"plain","text":" with the API Redux provided."}]},{"type":"code","lang":"ts","text":"import { createStore } from \"redux\";\nimport { Provider } from \"react-redux\";\n\nimport { rootReducer, RootState } from \"../client/service/reducer\";\n\napp.get(\"*\", (req: Express.Request, res: Express.Response) =\u003e {\n\t// pass request because store is likely dependent on request URL\n\tconst yourStore = yourStoreInitiator(req);\n\tconst preloadedStore: RootState = {\n\t\t// your store state\n\t};\n\t\n\tlet htmlBody = \"\";\n\tconst store = createStore(rootReducer, preloadedState);\n\t\n\ttry {\n\t\thtmlBody = ReactDOMServer.renderToString(\n\t\t\t\u003cProvider store={store}\u003e\n\t\t\t\t\u003cApp /\u003e\n\t\t\t\u003c/Provider\u003e\n\t\t);\n\t} catch (error) {\n\t\tconsole.error(error);\n\t}\n\t\n\t// store.getState() returns object so we have to manually stringify it\n\tconst initialState = JSON.stringify(store.getState());\n};"},{"type":"heading","children":[{"type":"plain","text":"HTML handler"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"Since the HTML is frequently edited with several library parts, an isolated handler makes it easier."}]},{"type":"code","lang":"ts","text":"const getFullHTML = (\n  htmlBody: string,\n  styleTags: string,\n  initialState: string,\n  helmet?: HelmetData\n) =\u003e {\n  return `\n    \u003c!DOCTYPE html\u003e\n    \u003chtml ${helmet?.htmlAttributes.toString()}\u003e\n      \u003chead\u003e\n        \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1\"\u003e\n        ${styleTags}\n        ${helmet?.title.toString()}\n        ${helmet?.meta.toString()}\n        ${helmet?.link.toString()}\n        \u003cstyle\u003e\n          @import url('\u003chttps://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700;900\u0026display=swap\u003e');\n          @import url('\u003chttps://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;400\u0026display=swap\u003e');\n        \u003c/style\u003e\n      \u003c/head\u003e\n      \u003cbody ${helmet?.bodyAttributes.toString()}\u003e\n        \u003cdiv id=\"app-root\"\u003e${htmlBody}\u003c/div\u003e\n        \u003cscript\u003ewindow.__INITIAL_STATE__ = ${initialState}\u003c/script\u003e\n        \u003cscript defer src=\"main.bundle.js\" type=\"text/javascript\" charset=\"utf-8\"\u003e\u003c/script\u003e\n        \u003cscript defer src=\"vendor.bundle.js\" type=\"text/javascript\" charset=\"utf-8\"\u003e\u003c/script\u003e\n      \u003c/body\u003e\n    \u003c/html\u003e\n  `;\n};"},{"type":"heading","children":[{"type":"plain","text":"Combine each part"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"Finally, combine all of the setups above."}]},{"type":"code","lang":"ts","text":"import * as Express from \"express\";\nimport * as React from \"react\";\nimport * as ReactDOMServer from \"react-dom/server\";\nimport { Helmet, HelmetData } from \"react-helmet\";\nimport { Provider } from \"react-redux\";\nimport { StaticRouter } from \"react-router-dom\";\nimport { createStore } from \"redux\";\nimport { ServerStyleSheet } from \"styled-components\";\n\nimport { App } from \"../client/App\";\nimport { rootReducer, RootState } from \"../client/service/reducer\";\n\nexport const renderer = (\n\treq: Express.Request,\n\tres: Express.Response,\n\tnext: Express.NextFunction,\n) =\u003e {\n\tapp.get(\"*\", (req: Express.Request, res: Express.Response) =\u003e {\n\tconst yourStore = yourStoreInitiator(req);\n\tconst preloadedStore: RootState = { /* your state */ };\n\t\n\tlet htmlBody = \"\";\n\tconst context = {};\n  const sheet = new ServerStyleSheet();\n  let styleTags = \"\";\n\tconst store = createStore(rootReducer, preloadedState);\n\tlet helmet;\n\t\n\ttry {\n\t  htmlBody = ReactDOMServer.renderToString(\n      sheet.collectStyles(\n        \u003cProvider store={store}\u003e\n\t        \u003cStaticRouter location={req.url} context={context}\u003e\n            \u003cApp /\u003e\n\t        \u003c/StaticRouter\u003e\n        \u003c/Provider\u003e\n      )\n    );\n    helmet = Helmet.renderStatic();\n    styleTags = sheet.getStyleTags();\n  } catch (error) {\n    console.error(error);\n  } finally {\n    sheet.seal();\n  }\n  const initialState = JSON.stringify(store.getState());\n\n  const fullHTML = getFullHTML(htmlBody, styleTags, initialState, helmet);\n\tres.send(fullHTML);\n};"},{"type":"paragraph","children":[{"type":"plain","text":"You can use "},{"type":"inlineCode","text":"curl -X GET localhost:3000"},{"type":"plain","text":" to check if the express server is returning the whole app in the first easily."}]}],"postMetadata":{"id":"refactor-blog-2-ssr","title":"Refactor Blog: (2) SSR","description":"","category":"Meta","language":["en-US"],"tags":[],"publishDate":"2021-03-26","pathname":"refactor-blog-2-ssr","zhTwLink":null,"filename":"Refactor Blog - (2) SSR (blog)"},"categoryList":{"Life":6,"Game Development":5,"Gaming":12,"League of Legends":8,"Meta":4,"Web Development":4,"HKT48":4,"Programming":3,"Movie":2},"last5posts":[{"id":"a-peek-of-the-world","title":"A Peek of the World","description":"I went to Copenhagen and London for my honeymoon, the first trip to Europe in my life. Some memories keep staying on my mind and I have many thoughts about them.","category":"Life","language":["en-US"],"tags":[],"publishDate":"2024-06-16","pathname":"a-peek-of-the-world","zhTwLink":null,"filename":"A Peek of the World (blog)"},{"id":"godot-essentials","title":"Godot Essentials","description":"The biggest lessons I learned in my first Godot project.","category":"Game Development","language":["en-US"],"tags":[],"publishDate":"2024-04-21","pathname":"godot-essentials","zhTwLink":null,"filename":"Godot Essentials (blog)"},{"id":"4-years-reflection","title":"4 Years Reflection","description":"Another two years of life as a full-time developer has passed. Many things changed and many lessons learned. It's a perfect timing to look back and reflect.","category":"Life","language":["en-US"],"tags":[],"publishDate":"2024-04-08","pathname":"4-years-reflection","zhTwLink":null,"filename":"4 Years Reflection (blog)"},{"id":"improving-greatness","title":"Improving Greatness","description":"Breath of the Wild is one of the most impactful game in last decade. Yet for its successor, Nintendo built an even more polished version on an already magnificent fundamental.","category":"Gaming","language":["en-US"],"tags":[],"publishDate":"2024-03-17","pathname":"improving-greatness","zhTwLink":null,"filename":"Improving Greatness (blog)"},{"id":"s13-recap","title":"S13 Recap","description":"After a three years gap, I'm back to league.","category":"League of Legends","language":["en-US"],"tags":[],"publishDate":"2024-01-23","pathname":"s13-recap","zhTwLink":null,"filename":"S13 Recap (blog)"}]},"__N_SSG":true},"page":"/blog/[pathname]","query":{"pathname":"refactor-blog-2-ssr"},"buildId":"DprFBLrygr1bgHJ6nxl5c","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>