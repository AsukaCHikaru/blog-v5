<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Next.js App Font Not Loaded on Remote Machine Issue | Asuka Wang</title><meta name="description" content="Asuka Wang&#x27;s blog"/><meta property="og:title" content="Next.js App Font Not Loaded on Remote Machine Issue | Asuka Wang"/><meta property="twitter:title" content="Next.js App Font Not Loaded on Remote Machine Issue | Asuka Wang"/><meta name="next-head-count" content="6"/><link rel="preconnect" href="/" crossorigin="anonymous"/><script id="theme-document" data-nscript="beforeInteractive">
        if (typeof window !== "undefined") {
          const savedTheme = localStorage.getItem("ASUKACHIKARU_THEME");
          const html = document.documentElement;
          const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches
            ? 'DARK'
            : 'LIGHT';
          if (savedTheme === "DARK" || systemTheme === "DARK") {
            html.classList.add('dark');
            html.style.backgroundColor = "#27211F";
          } else {
            html.classList.remove('dark');
            html.style.backgroundColor = "#F5F2E8";
          }
        }
      </script><link rel="preload" href="/_next/static/css/37c41217e71a4ebc.css" as="style"/><link rel="stylesheet" href="/_next/static/css/37c41217e71a4ebc.css" data-n-g=""/><link rel="preload" href="/_next/static/css/d8403707d10b0477.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d8403707d10b0477.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-b8f8d6679aaa5f42.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-f2ca60db2beb93ed.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e93b23f29c9aa536.js" defer=""></script><script src="/_next/static/chunks/542-7be5b5539309fe0b.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bpathname%5D-d22eb341f0d05e6a.js" defer=""></script><script src="/_next/static/0gZBZ30HDMib0fPMH7n7i/_buildManifest.js" defer=""></script><script src="/_next/static/0gZBZ30HDMib0fPMH7n7i/_ssgManifest.js" defer=""></script></head><body><div id="__next"><main class="__variable_e0546c font-serif"><div class="text-dark bg-light dark:text-light dark:bg-dark"><div class="max-w-7xl mx-auto grid grid-cols-12 gap-0 lg:gap-4"><div class="mt-12 mb-6 col-span-10 col-start-2 lg:col-span-8 lg:col-start-3 grid grid-cols-10 text-center"><div class="col-start-1 col-span-10 text-xl lg:text-3xl font-extrabold">Asuka Wang</div><div class=" col-span-6 col-start-3 lg:col-span-6 lg:col-start-3 mt-4 flex justify-between leading-[32px] lg:leading-[40px] text-xs lg:text-base "><a href="/blog/">BLOG</a><a href="/snapshot/">SNAPSHOT</a><a href="/about/">ABOUT</a></div><div class="col-span-1 col-start-10 mt-4 flex justify-end"><button class="whitespace-pre text-right text-xs lg:text-sm leading-4">dark<!-- -->
<!-- -->mode</button></div><div class="col-span-10 my-2 border-t border-b h-2 border-dark dark:border-light"></div></div><div class="mb-6 col-span-10 col-start-2 lg:col-span-8 lg:col-start-3 text-center"><h1 class="mb-2 text-4xl lg:text-6xl lg:leading-tight font-extrabold">Next.js App Font Not Loaded on Remote Machine Issue</h1><div class="text-md lg:text-xl"><span class="inline-block mr-2 pr-2 true">June 5, 2023</span></div></div><div class="col-span-10 col-start-2 lg:col-span-8 lg:col-start-3"><div class="mb-6 text-lg lg:text-xl lg:leading-8"><h2 class="mt-8 text-2xl lg:text-4xl font-semibold"><span>TL;DR</span></h2></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">@next/font</code><span> config </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">display: option</code><span> will switch to fallback if the font takes more than 100ms to load. To ensure the font loading, use </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">display: swap</code><span>.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><h2 class="mt-8 text-2xl lg:text-4xl font-semibold"><span>Issue</span></h2></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>This blog is built in Next.js. When I first released it, there was an issue that the font only loads on my development machine. It reproduces on every remote machine, even if I access the dev server from the same wifi.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><h3 class="mt-8 text-xl lg:text-3xl font-semibold"><span>Configuration</span></h3></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>I hosted my font using local .woff2 file, which I downloaded as .otf from </span><a href="https://fonts.google.com/" class="text-blue-400 underline" rel="noreferrer noopener" target="_blank">google font</a><span> then converted to .woff2 from the first converter I found on google.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>The font file is loaded from a </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">&lt;link&gt;</code><span> element in </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">_document.tsx</code><span>.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><pre class="my-6 border rounded-md text-base leading-4"><code class="font-courier language-tsx rounded-md">export default function Document() {
  return (
    &lt;Html lang=&quot;en&quot;&gt;
      &lt;Head /&gt;
      &lt;link
        rel=&quot;preload&quot;
        href=&quot;/fonts/NotoSerifJP-Regular.woff2&quot;
        as=&quot;font&quot;
        type=&quot;font/woff2&quot;
      /&gt;
      &lt;body&gt;
        &lt;Main /&gt;
        &lt;NextScript /&gt;
      &lt;/body&gt;
    &lt;/Html&gt;
  )
}</code></pre></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>Then I set the font face in </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">global.css</code><span> and applied the </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">font-family</code><span> to </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">body</code><span>.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><pre class="my-6 border rounded-md text-base leading-4"><code class="font-courier language-css rounded-md">@font-face {
  font-family: &#x27;NotoSerifJP&#x27;;
  font-style: normal;
  font-weight: 400;
  font-display: optional;
  src: url(/fonts/NotoSerifJP-Regular.woff2) format(woff2);
}

html,
body {
  font-family: &#x27;NotoSerifJP&#x27;;
}</code></pre></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><h3 class="mt-8 text-xl lg:text-3xl font-semibold"><span>Behavior</span></h3></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>When access either the dev server or the prod environment from the development machine, the font loads successfully. But when access from any other single machine on the world, the font won&#x27;t load and the app switches back to default sans font.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>The font file is successfully fetched on either machine, but on the remote machine the fetched font&#x27;s content becomes the default sans font. I used some online .woff2 preview tool and it clearly shows that the downloaded .woff2 file is the default sans font. Such issue didn&#x27;t happen on the development machine.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><img alt="" src="/images/nextjs-app-font-not-loaded-on-remote-machine-issue_1.png" width="600" height="400" decoding="async" data-nimg="1" class="m-auto" loading="lazy" style="color:transparent"/><span class="flex justify-center text-secondDark dark:text-secondLight text-lg">Font file response on development machine</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><img alt="" src="/images/nextjs-app-font-not-loaded-on-remote-machine-issue_2.png" width="600" height="400" decoding="async" data-nimg="1" class="m-auto" loading="lazy" style="color:transparent"/><span class="flex justify-center text-secondDark dark:text-secondLight text-lg">Font file response on remote machine</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><h3 class="mt-8 text-xl lg:text-3xl font-semibold"><span>Attempts</span></h3></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>I tried the configurations shown in </span><a href="https://www.youtube.com/watch?v=L8_98i_bMMA" class="text-blue-400 underline" rel="noreferrer noopener" target="_blank">this youtube video</a><span>.
(It was super easy to understand, turns out it was a Vercel&#x27;s developer&#x27;s channel.)</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>I discarded the local .woff2 file and tried </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">@next/font</code><span>. Since I was using Tailwindcss, I set the font variable and the </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">tainwind.config.js</code><span> configurations.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>After above configuration, the latin part of the font started to load on remote machine. Only the Japanese and Chinese parts remain the default sans font.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><h3 class="mt-8 text-xl lg:text-3xl font-semibold"><span>Root Cause</span></h3></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>When creating font const using </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">@next/font</code><span>, the </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">display</code><span> option is defaulted to </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">optional</code><span>, which will switch to fallback font if the loading time is over 100ms.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>Since I was using </span><a href="https://fonts.google.com/noto/specimen/Noto+Serif+JP?query=noto+se" class="text-blue-400 underline" rel="noreferrer noopener" target="_blank">Noto Serif JP</a><span>, the Japanese subset is way heavier than the latin set, which makes the Japanese part fallbacks to default font.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>When I was hosting the .woff2 file instead of using </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">@next/font</code><span>, I didn&#x27;t set the subset rules, hence made the whole font file too big to load, thus on every remote machine the font fallbacks. Only on the development machine, the font was not loaded through http but local disc, which it makes the below 100ms line.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><h3 class="mt-8 text-xl lg:text-3xl font-semibold"><span>Solution</span></h3></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>Use </span><code class="px-1 font-courier text-gray-300 bg-gray-700 rounded-sm">display: swap</code><span> to ensure font loading.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><span>It causes some </span><a href="https://fonts.google.com/knowledge/glossary/fout" class="text-blue-400 underline" rel="noreferrer noopener" target="_blank">FOUT</a><span>, but it&#x27;s a way lesser evil compare to the origin issue.</span></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><h2 class="mt-8 text-2xl lg:text-4xl font-semibold"><span>References</span></h2></div><div class="mb-6 text-lg lg:text-xl lg:leading-8"><ul class="list-disc list-inside mx-8"><li><a href="https://www.satoooh.org/blog/next-font-display" class="text-blue-400 underline" rel="noreferrer noopener" target="_blank">@next/font で初回読み込み時にフォントが適用されない</a></li></ul></div></div><div class="mt-6 mb-12 text-center col-span-12 lg:col-span-8 lg:col-start-3"><a href="https://asukachikaru.com" rel="noopener noreferrer" target="_blank">asukachikaru.com</a> <!-- -->2018-</div></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postContent":[{"type":"heading","children":[{"type":"plain","text":"TL;DR"}],"depth":1},{"type":"paragraph","children":[{"type":"inlineCode","text":"@next/font"},{"type":"plain","text":" config "},{"type":"inlineCode","text":"display: option"},{"type":"plain","text":" will switch to fallback if the font takes more than 100ms to load. To ensure the font loading, use "},{"type":"inlineCode","text":"display: swap"},{"type":"plain","text":"."}]},{"type":"heading","children":[{"type":"plain","text":"Issue"}],"depth":1},{"type":"paragraph","children":[{"type":"plain","text":"This blog is built in Next.js. When I first released it, there was an issue that the font only loads on my development machine. It reproduces on every remote machine, even if I access the dev server from the same wifi."}]},{"type":"heading","children":[{"type":"plain","text":"Configuration"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"I hosted my font using local .woff2 file, which I downloaded as .otf from "},{"type":"link","text":"google font","url":"https://fonts.google.com/"},{"type":"plain","text":" then converted to .woff2 from the first converter I found on google."}]},{"type":"paragraph","children":[{"type":"plain","text":"The font file is loaded from a "},{"type":"inlineCode","text":"\u003clink\u003e"},{"type":"plain","text":" element in "},{"type":"inlineCode","text":"_document.tsx"},{"type":"plain","text":"."}]},{"type":"code","lang":"tsx","text":"export default function Document() {\n  return (\n    \u003cHtml lang=\"en\"\u003e\n      \u003cHead /\u003e\n      \u003clink\n        rel=\"preload\"\n        href=\"/fonts/NotoSerifJP-Regular.woff2\"\n        as=\"font\"\n        type=\"font/woff2\"\n      /\u003e\n      \u003cbody\u003e\n        \u003cMain /\u003e\n        \u003cNextScript /\u003e\n      \u003c/body\u003e\n    \u003c/Html\u003e\n  )\n}"},{"type":"paragraph","children":[{"type":"plain","text":"Then I set the font face in "},{"type":"inlineCode","text":"global.css"},{"type":"plain","text":" and applied the "},{"type":"inlineCode","text":"font-family"},{"type":"plain","text":" to "},{"type":"inlineCode","text":"body"},{"type":"plain","text":"."}]},{"type":"code","lang":"css","text":"@font-face {\n  font-family: 'NotoSerifJP';\n  font-style: normal;\n  font-weight: 400;\n  font-display: optional;\n  src: url(/fonts/NotoSerifJP-Regular.woff2) format(woff2);\n}\n\nhtml,\nbody {\n  font-family: 'NotoSerifJP';\n}"},{"type":"heading","children":[{"type":"plain","text":"Behavior"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"When access either the dev server or the prod environment from the development machine, the font loads successfully. But when access from any other single machine on the world, the font won't load and the app switches back to default sans font."}]},{"type":"paragraph","children":[{"type":"plain","text":"The font file is successfully fetched on either machine, but on the remote machine the fetched font's content becomes the default sans font. I used some online .woff2 preview tool and it clearly shows that the downloaded .woff2 file is the default sans font. Such issue didn't happen on the development machine."}]},{"type":"image","url":"nextjs-app-font-not-loaded-on-remote-machine-issue_1.png","caption":"Font file response on development machine","alt":null},{"type":"image","url":"nextjs-app-font-not-loaded-on-remote-machine-issue_2.png","caption":"Font file response on remote machine","alt":null},{"type":"heading","children":[{"type":"plain","text":"Attempts"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"I tried the configurations shown in "},{"type":"link","text":"this youtube video","url":"https://www.youtube.com/watch?v=L8_98i_bMMA"},{"type":"plain","text":".\n(It was super easy to understand, turns out it was a Vercel's developer's channel.)"}]},{"type":"paragraph","children":[{"type":"plain","text":"I discarded the local .woff2 file and tried "},{"type":"inlineCode","text":"@next/font"},{"type":"plain","text":". Since I was using Tailwindcss, I set the font variable and the "},{"type":"inlineCode","text":"tainwind.config.js"},{"type":"plain","text":" configurations."}]},{"type":"paragraph","children":[{"type":"plain","text":"After above configuration, the latin part of the font started to load on remote machine. Only the Japanese and Chinese parts remain the default sans font."}]},{"type":"heading","children":[{"type":"plain","text":"Root Cause"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"When creating font const using "},{"type":"inlineCode","text":"@next/font"},{"type":"plain","text":", the "},{"type":"inlineCode","text":"display"},{"type":"plain","text":" option is defaulted to "},{"type":"inlineCode","text":"optional"},{"type":"plain","text":", which will switch to fallback font if the loading time is over 100ms."}]},{"type":"paragraph","children":[{"type":"plain","text":"Since I was using "},{"type":"link","text":"Noto Serif JP","url":"https://fonts.google.com/noto/specimen/Noto+Serif+JP?query=noto+se"},{"type":"plain","text":", the Japanese subset is way heavier than the latin set, which makes the Japanese part fallbacks to default font."}]},{"type":"paragraph","children":[{"type":"plain","text":"When I was hosting the .woff2 file instead of using "},{"type":"inlineCode","text":"@next/font"},{"type":"plain","text":", I didn't set the subset rules, hence made the whole font file too big to load, thus on every remote machine the font fallbacks. Only on the development machine, the font was not loaded through http but local disc, which it makes the below 100ms line."}]},{"type":"heading","children":[{"type":"plain","text":"Solution"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"Use "},{"type":"inlineCode","text":"display: swap"},{"type":"plain","text":" to ensure font loading."}]},{"type":"paragraph","children":[{"type":"plain","text":"It causes some "},{"type":"link","text":"FOUT","url":"https://fonts.google.com/knowledge/glossary/fout"},{"type":"plain","text":", but it's a way lesser evil compare to the origin issue."}]},{"type":"heading","children":[{"type":"plain","text":"References"}],"depth":1},{"type":"list","ordered":false,"children":[{"type":"listItem","children":[{"type":"link","text":"@next/font で初回読み込み時にフォントが適用されない","url":"https://www.satoooh.org/blog/next-font-display"}]}]}],"postSummary":{"id":"nextjs-app-font-not-loaded-on-remote-machine-issue","title":"Next.js App Font Not Loaded on Remote Machine Issue","category":"Front-end","language":["en-US"],"tags":["Next.js"],"publishDate":"2023-06-05","pathname":"nextjs-app-font-not-loaded-on-remote-machine-issue","zhTwLink":null,"filename":"Next.js App Font Not Loaded on Remote Machine Issue (blog)"}},"__N_SSG":true},"page":"/blog/[pathname]","query":{"pathname":"nextjs-app-font-not-loaded-on-remote-machine-issue"},"buildId":"0gZBZ30HDMib0fPMH7n7i","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>