<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Next.js App Font Not Loaded on Remote Machine Issue | Asuka Wang</title><meta name="description" content="Debugging note of a source loading issue that never reproduces on the dev machine."/><meta property="og:title" content="Next.js App Font Not Loaded on Remote Machine Issue | Asuka Wang"/><meta property="twitter:title" content="Next.js App Font Not Loaded on Remote Machine Issue | Asuka Wang"/><meta name="next-head-count" content="6"/><script id="theme-document" data-nscript="beforeInteractive">
        if (typeof window !== "undefined") {
          const savedTheme = localStorage.getItem("ASUKACHIKARU_THEME");
          const html = document.documentElement;
          const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches
            ? 'DARK'
            : 'LIGHT';
          if (savedTheme === "DARK" || systemTheme === "DARK") {
            html.classList.add('dark');
            html.style.backgroundColor = "#27211F";
          } else {
            html.classList.remove('dark');
            html.style.backgroundColor = "#F5F2E8";
          }
        }
      </script><link rel="preload" href="/_next/static/css/e022dc1c2f1eadc9.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e022dc1c2f1eadc9.css" data-n-g=""/><link rel="preload" href="/_next/static/css/1a859005e305b06e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1a859005e305b06e.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-b8f8d6679aaa5f42.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-f2ca60db2beb93ed.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2d2d21d61a95773e.js" defer=""></script><script src="/_next/static/chunks/970-e8ce68274b194f36.js" defer=""></script><script src="/_next/static/chunks/995-833faf1b6733bc08.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bpathname%5D-d306b0cb9bdf2a22.js" defer=""></script><script src="/_next/static/b2O70Ct3E4Fuh0ajn30AQ/_buildManifest.js" defer=""></script><script src="/_next/static/b2O70Ct3E4Fuh0ajn30AQ/_ssgManifest.js" defer=""></script></head><body><div id="__next"><main><div class="text-color"><div class="SiteLayout_container__1SYq5"><div class="SiteHeader_container__8tKwA"><div class="SiteHeader_dark-mode-button-wrapper__FKJN8"><button class="DarkModeButton_button__lLWPY interactive-color">light mode</button></div><div class="SiteHeader_nav-container__oEq2d"><div class="SiteHeader_section-container__tAKnZ"><a class="SiteHeader_section-link__9DmFE interactive-color text-color" href="/blog/">BLOG</a><a class="SiteHeader_section-link__9DmFE interactive-color " href="/about/">ABOUT</a></div><a class="SiteHeader_publication-folio___ZFZS text-color" href="/">ASUKA WANG</a></div><div class="SiteHeader_divider__cq_R_ border-color-100"></div></div><div><div class="PostDetailPageHeader_container__fcMw9"><h1 class="PostDetailPageHeader_title__YwZEK">Next.js App Font Not Loaded on Remote Machine Issue</h1><h2 class="PostDetailPageHeader_description__HSXhn">Debugging note of a source loading issue that never reproduces on the dev machine.</h2><div class="PostDetailPageHeader_publish-date__pMF22">June 5, 2023</div></div><div class="ContentLayout_container__U6Gem"><div class="PostDetailPage_main-content-container__sotxu"><div class="PostBodyBlock_wrapper__wRxJc"><h2 class="PostBodyBlock_h2__z8Iri" id="TL;DR"><span>TL;DR</span></h2></div><div class="PostBodyBlock_wrapper__wRxJc"><code class="PostBodyBlock_inline-code__TAzYM">@next/font</code><span> config </span><code class="PostBodyBlock_inline-code__TAzYM">display: option</code><span> will switch to fallback if the font takes more than 100ms to load. To ensure the font loading, use </span><code class="PostBodyBlock_inline-code__TAzYM">display: swap</code><span>.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><h2 class="PostBodyBlock_h2__z8Iri" id="Issue"><span>Issue</span></h2></div><div class="PostBodyBlock_wrapper__wRxJc"><span>This blog is built in Next.js. When I first released it, there was an issue that the font only loads on my development machine. It reproduces on every remote machine, even if I access the dev server from the same wifi.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><h3 class="PostBodyBlock_h3__BUDla" id="Configuration"><span>Configuration</span></h3></div><div class="PostBodyBlock_wrapper__wRxJc"><span>I hosted my font using local .woff2 file, which I downloaded as .otf from </span><a href="https://fonts.google.com/" class="PostBodyBlock_link__faaEN" rel="noreferrer noopener" target="_blank">google font</a><span> then converted to .woff2 from the first converter I found on google.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><span>The font file is loaded from a </span><code class="PostBodyBlock_inline-code__TAzYM">&lt;link&gt;</code><span> element in </span><code class="PostBodyBlock_inline-code__TAzYM">_document.tsx</code><span>.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><pre class="CodeBlock_block__wRht1"><code class="CodeBlock_code__1aD9x language-tsx">export default function Document() {
  return (
    &lt;Html lang=&quot;en&quot;&gt;
      &lt;Head /&gt;
      &lt;link
        rel=&quot;preload&quot;
        href=&quot;/fonts/NotoSerifJP-Regular.woff2&quot;
        as=&quot;font&quot;
        type=&quot;font/woff2&quot;
      /&gt;
      &lt;body&gt;
        &lt;Main /&gt;
        &lt;NextScript /&gt;
      &lt;/body&gt;
    &lt;/Html&gt;
  )
}</code></pre></div><div class="PostBodyBlock_wrapper__wRxJc"><span>Then I set the font face in </span><code class="PostBodyBlock_inline-code__TAzYM">global.css</code><span> and applied the </span><code class="PostBodyBlock_inline-code__TAzYM">font-family</code><span> to </span><code class="PostBodyBlock_inline-code__TAzYM">body</code><span>.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><pre class="CodeBlock_block__wRht1"><code class="CodeBlock_code__1aD9x language-css">@font-face {
  font-family: &#x27;NotoSerifJP&#x27;;
  font-style: normal;
  font-weight: 400;
  font-display: optional;
  src: url(/fonts/NotoSerifJP-Regular.woff2) format(woff2);
}

html,
body {
  font-family: &#x27;NotoSerifJP&#x27;;
}</code></pre></div><div class="PostBodyBlock_wrapper__wRxJc"><h3 class="PostBodyBlock_h3__BUDla" id="Behavior"><span>Behavior</span></h3></div><div class="PostBodyBlock_wrapper__wRxJc"><span>When access either the dev server or the prod environment from the development machine, the font loads successfully. But when access from any other single machine on the world, the font won&#x27;t load and the app switches back to default sans font.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><span>The font file is successfully fetched on either machine, but on the remote machine the fetched font&#x27;s content becomes the default sans font. I used some online .woff2 preview tool and it clearly shows that the downloaded .woff2 file is the default sans font. Such issue didn&#x27;t happen on the development machine.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><img alt="" src="/images/nextjs-app-font-not-loaded-on-remote-machine-issue_1.png" width="600" height="400" decoding="async" data-nimg="1" class="PostBodyBlock_image__KsPkW" loading="lazy" style="color:transparent"/><span class="PostBodyBlock_image-caption__ODIhE text-color-second">Font file response on development machine</span></div><div class="PostBodyBlock_wrapper__wRxJc"><img alt="" src="/images/nextjs-app-font-not-loaded-on-remote-machine-issue_2.png" width="600" height="400" decoding="async" data-nimg="1" class="PostBodyBlock_image__KsPkW" loading="lazy" style="color:transparent"/><span class="PostBodyBlock_image-caption__ODIhE text-color-second">Font file response on remote machine</span></div><div class="PostBodyBlock_wrapper__wRxJc"><h3 class="PostBodyBlock_h3__BUDla" id="Attempts"><span>Attempts</span></h3></div><div class="PostBodyBlock_wrapper__wRxJc"><span>I tried the configurations shown in </span><a href="https://www.youtube.com/watch?v=L8_98i_bMMA" class="PostBodyBlock_link__faaEN" rel="noreferrer noopener" target="_blank">this youtube video</a><span>.
(It was super easy to understand, turns out it was a Vercel&#x27;s developer&#x27;s channel.)</span></div><div class="PostBodyBlock_wrapper__wRxJc"><span>I discarded the local .woff2 file and tried </span><code class="PostBodyBlock_inline-code__TAzYM">@next/font</code><span>. Since I was using Tailwindcss, I set the font variable and the </span><code class="PostBodyBlock_inline-code__TAzYM">tainwind.config.js</code><span> configurations.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><span>After above configuration, the latin part of the font started to load on remote machine. Only the Japanese and Chinese parts remain the default sans font.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><h3 class="PostBodyBlock_h3__BUDla" id="Root-Cause"><span>Root Cause</span></h3></div><div class="PostBodyBlock_wrapper__wRxJc"><span>When creating font const using </span><code class="PostBodyBlock_inline-code__TAzYM">@next/font</code><span>, the </span><code class="PostBodyBlock_inline-code__TAzYM">display</code><span> option is defaulted to </span><code class="PostBodyBlock_inline-code__TAzYM">optional</code><span>, which will switch to fallback font if the loading time is over 100ms.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><span>Since I was using </span><a href="https://fonts.google.com/noto/specimen/Noto+Serif+JP?query=noto+se" class="PostBodyBlock_link__faaEN" rel="noreferrer noopener" target="_blank">Noto Serif JP</a><span>, the Japanese subset is way heavier than the latin set, which makes the Japanese part fallbacks to default font.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><span>When I was hosting the .woff2 file instead of using </span><code class="PostBodyBlock_inline-code__TAzYM">@next/font</code><span>, I didn&#x27;t set the subset rules, hence made the whole font file too big to load, thus on every remote machine the font fallbacks. Only on the development machine, the font was not loaded through http but local disc, which it makes the below 100ms line.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><h3 class="PostBodyBlock_h3__BUDla" id="Solution"><span>Solution</span></h3></div><div class="PostBodyBlock_wrapper__wRxJc"><span>Use </span><code class="PostBodyBlock_inline-code__TAzYM">display: swap</code><span> to ensure font loading.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><span>It causes some </span><a href="https://fonts.google.com/knowledge/glossary/fout" class="PostBodyBlock_link__faaEN" rel="noreferrer noopener" target="_blank">FOUT</a><span>, but it&#x27;s a way lesser evil compare to the origin issue.</span></div><div class="PostBodyBlock_wrapper__wRxJc"><h2 class="PostBodyBlock_h2__z8Iri" id="References"><span>References</span></h2></div><div class="PostBodyBlock_wrapper__wRxJc"><ul class="PostBodyBlock_ul__QtcuL"><li><a href="https://www.satoooh.org/blog/next-font-display" class="PostBodyBlock_link__faaEN" rel="noreferrer noopener" target="_blank">@next/font で初回読み込み時にフォントが適用されない</a></li></ul></div></div><div class="SideColumn_container__qetoC"><div class="SideColumn_children__CI98R"><div><div class="SideColumnHeader_container__EGRMu border-color">TABLE OF CONTENT</div><ul class="TableOfContentColumn_ul__7wuVs interactive-list-color"><li class="TableOfContentColumn_li__FUe4z"><a class="TableOfContentColumn_link__5qS3c interactive-color" href="/blog/nextjs-app-font-not-loaded-on-remote-machine-issue/#TL;DR">TL;DR</a></li><li class="TableOfContentColumn_li__FUe4z"><a class="TableOfContentColumn_link__5qS3c interactive-color" href="/blog/nextjs-app-font-not-loaded-on-remote-machine-issue/#Issue">Issue</a></li><li class="TableOfContentColumn_li__FUe4z"><div class="TableOfContentColumn_indent__CXWB4"></div><a class="TableOfContentColumn_link__5qS3c interactive-color" href="/blog/nextjs-app-font-not-loaded-on-remote-machine-issue/#Configuration">Configuration</a></li><li class="TableOfContentColumn_li__FUe4z"><div class="TableOfContentColumn_indent__CXWB4"></div><a class="TableOfContentColumn_link__5qS3c interactive-color" href="/blog/nextjs-app-font-not-loaded-on-remote-machine-issue/#Behavior">Behavior</a></li><li class="TableOfContentColumn_li__FUe4z"><div class="TableOfContentColumn_indent__CXWB4"></div><a class="TableOfContentColumn_link__5qS3c interactive-color" href="/blog/nextjs-app-font-not-loaded-on-remote-machine-issue/#Attempts">Attempts</a></li><li class="TableOfContentColumn_li__FUe4z"><div class="TableOfContentColumn_indent__CXWB4"></div><a class="TableOfContentColumn_link__5qS3c interactive-color" href="/blog/nextjs-app-font-not-loaded-on-remote-machine-issue/#Root-Cause">Root Cause</a></li><li class="TableOfContentColumn_li__FUe4z"><div class="TableOfContentColumn_indent__CXWB4"></div><a class="TableOfContentColumn_link__5qS3c interactive-color" href="/blog/nextjs-app-font-not-loaded-on-remote-machine-issue/#Solution">Solution</a></li><li class="TableOfContentColumn_li__FUe4z"><a class="TableOfContentColumn_link__5qS3c interactive-color" href="/blog/nextjs-app-font-not-loaded-on-remote-machine-issue/#References">References</a></li></ul></div><div><div class="SideColumnHeader_container__EGRMu border-color">ARCHIVE</div><div class="ArchiveList_container__hCApW"><a class="ArchiveList_link__xJseS interactive-color border-color" href="/blog/a-peek-of-the-world/"><div class="ArchiveList_title__TYWpQ">A Peek of the World</div><div class="ArchiveList_description__EB_uf">I went to Copenhagen and London for my honeymoon, the first trip to Europe in my life. Some memories keep staying on my mind and I have many thoughts about them.</div><div class="ArchiveList_publish-date__71JcX">June 16, 2024</div></a><a class="ArchiveList_link__xJseS interactive-color border-color" href="/blog/godot-essentials/"><div class="ArchiveList_title__TYWpQ">Godot Essentials</div><div class="ArchiveList_description__EB_uf">The biggest lessons I learned in my first Godot project.</div><div class="ArchiveList_publish-date__71JcX">April 21, 2024</div></a><a class="ArchiveList_link__xJseS interactive-color border-color" href="/blog/4-years-reflection/"><div class="ArchiveList_title__TYWpQ">4 Years Reflection</div><div class="ArchiveList_description__EB_uf">Another two years of life as a full-time developer has passed. Many things changed and many lessons learned. It&#x27;s a perfect timing to look back and reflect.</div><div class="ArchiveList_publish-date__71JcX">April 8, 2024</div></a><a class="ArchiveList_link__xJseS interactive-color border-color" href="/blog/improving-greatness/"><div class="ArchiveList_title__TYWpQ">Improving Greatness</div><div class="ArchiveList_description__EB_uf">Breath of the Wild is one of the most impactful game in last decade. Yet for its successor, Nintendo built an even more polished version on an already magnificent fundamental.</div><div class="ArchiveList_publish-date__71JcX">March 17, 2024</div></a><a class="ArchiveList_link__xJseS interactive-color border-color" href="/blog/s13-recap/"><div class="ArchiveList_title__TYWpQ">S13 Recap</div><div class="ArchiveList_description__EB_uf">After a three years gap, I&#x27;m back to league.</div><div class="ArchiveList_publish-date__71JcX">January 23, 2024</div></a><div class="ArchiveList_full-link-wrapper__1kxy4"><a class="ArchiveList_full-link__D_qqY interactive-color" href="/blog/archive/">FULL LIST</a></div></div></div><div><div class="SideColumnHeader_container__EGRMu border-color">CATEGORY</div><div class="CategoryList_container__NUpAr"><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Gaming"><span class="CategoryList_category__FXiir">Gaming</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">12</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=League%20of%20Legends"><span class="CategoryList_category__FXiir">League of Legends</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">8</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Life"><span class="CategoryList_category__FXiir">Life</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">6</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Game%20Development"><span class="CategoryList_category__FXiir">Game Development</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">5</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Meta"><span class="CategoryList_category__FXiir">Meta</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">4</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Web%20Development"><span class="CategoryList_category__FXiir">Web Development</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">4</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=HKT48"><span class="CategoryList_category__FXiir">HKT48</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">4</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Programming"><span class="CategoryList_category__FXiir">Programming</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">3</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Movie"><span class="CategoryList_category__FXiir">Movie</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">2</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div></div></div></div><div class="SideColumn_top-button-wrapper__YtDii"><button class="SideColumn_top-button__Of4Q7 interactive-color">TOP</button></div></div><div class="PostDetailPage_below-content-container__vb8mk"><div class="PostDetailPage_below-content-divider__M6tw6 border-color"></div><div class="PostDetailPage_below-content-wrapper__9YV1H"><div class="BelowPostDetailColumnHeader_container__1uMJD"><div class="BelowPostDetailColumnHeader_double-border__4SJJM border-color"></div><div class="BelowPostDetailColumnHeader_title__QCi0c">ARCHIVE</div><div class="BelowPostDetailColumnHeader_double-border__4SJJM border-color"></div></div><div class="ArchiveList_container__hCApW"><a class="ArchiveList_link__xJseS interactive-color border-color" href="/blog/a-peek-of-the-world/"><div class="ArchiveList_title__TYWpQ">A Peek of the World</div><div class="ArchiveList_description__EB_uf">I went to Copenhagen and London for my honeymoon, the first trip to Europe in my life. Some memories keep staying on my mind and I have many thoughts about them.</div><div class="ArchiveList_publish-date__71JcX">June 16, 2024</div></a><a class="ArchiveList_link__xJseS interactive-color border-color" href="/blog/godot-essentials/"><div class="ArchiveList_title__TYWpQ">Godot Essentials</div><div class="ArchiveList_description__EB_uf">The biggest lessons I learned in my first Godot project.</div><div class="ArchiveList_publish-date__71JcX">April 21, 2024</div></a><a class="ArchiveList_link__xJseS interactive-color border-color" href="/blog/4-years-reflection/"><div class="ArchiveList_title__TYWpQ">4 Years Reflection</div><div class="ArchiveList_description__EB_uf">Another two years of life as a full-time developer has passed. Many things changed and many lessons learned. It&#x27;s a perfect timing to look back and reflect.</div><div class="ArchiveList_publish-date__71JcX">April 8, 2024</div></a><a class="ArchiveList_link__xJseS interactive-color border-color" href="/blog/improving-greatness/"><div class="ArchiveList_title__TYWpQ">Improving Greatness</div><div class="ArchiveList_description__EB_uf">Breath of the Wild is one of the most impactful game in last decade. Yet for its successor, Nintendo built an even more polished version on an already magnificent fundamental.</div><div class="ArchiveList_publish-date__71JcX">March 17, 2024</div></a><a class="ArchiveList_link__xJseS interactive-color border-color" href="/blog/s13-recap/"><div class="ArchiveList_title__TYWpQ">S13 Recap</div><div class="ArchiveList_description__EB_uf">After a three years gap, I&#x27;m back to league.</div><div class="ArchiveList_publish-date__71JcX">January 23, 2024</div></a><div class="ArchiveList_full-link-wrapper__1kxy4"><a class="ArchiveList_full-link__D_qqY interactive-color" href="/blog/archive/">FULL LIST</a></div></div></div><div class="PostDetailPage_below-content-wrapper__9YV1H"><div class="BelowPostDetailColumnHeader_container__1uMJD"><div class="BelowPostDetailColumnHeader_double-border__4SJJM border-color"></div><div class="BelowPostDetailColumnHeader_title__QCi0c">CATEGORY</div><div class="BelowPostDetailColumnHeader_double-border__4SJJM border-color"></div></div><div class="CategoryList_container__NUpAr"><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Gaming"><span class="CategoryList_category__FXiir">Gaming</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">12</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=League%20of%20Legends"><span class="CategoryList_category__FXiir">League of Legends</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">8</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Life"><span class="CategoryList_category__FXiir">Life</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">6</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Game%20Development"><span class="CategoryList_category__FXiir">Game Development</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">5</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Meta"><span class="CategoryList_category__FXiir">Meta</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">4</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Web%20Development"><span class="CategoryList_category__FXiir">Web Development</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">4</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=HKT48"><span class="CategoryList_category__FXiir">HKT48</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">4</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Programming"><span class="CategoryList_category__FXiir">Programming</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">3</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div><div><a class="CategoryList_link__TpU6s interactive-color" href="/blog/archive/?category=Movie"><span class="CategoryList_category__FXiir">Movie</span><span class="CategoryList_border__N_apZ border-color"></span><span class="CategoryList_post-number__ItwYq">2</span><span class="CategoryList_post-number-label__tOPrk">POST<!-- -->S</span></a></div></div></div></div></div></div><div class="SiteFooter_container__0v6cR border-color"><a href="https://asukachikaru.com" rel="noopener noreferrer" target="_blank" class="SiteFooter_link__RuMSe interactive-color">asukachikaru.com 2018-</a></div></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postContent":[{"type":"heading","children":[{"type":"plain","text":"TL;DR"}],"depth":1},{"type":"paragraph","children":[{"type":"inlineCode","text":"@next/font"},{"type":"plain","text":" config "},{"type":"inlineCode","text":"display: option"},{"type":"plain","text":" will switch to fallback if the font takes more than 100ms to load. To ensure the font loading, use "},{"type":"inlineCode","text":"display: swap"},{"type":"plain","text":"."}]},{"type":"heading","children":[{"type":"plain","text":"Issue"}],"depth":1},{"type":"paragraph","children":[{"type":"plain","text":"This blog is built in Next.js. When I first released it, there was an issue that the font only loads on my development machine. It reproduces on every remote machine, even if I access the dev server from the same wifi."}]},{"type":"heading","children":[{"type":"plain","text":"Configuration"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"I hosted my font using local .woff2 file, which I downloaded as .otf from "},{"type":"link","text":"google font","url":"https://fonts.google.com/"},{"type":"plain","text":" then converted to .woff2 from the first converter I found on google."}]},{"type":"paragraph","children":[{"type":"plain","text":"The font file is loaded from a "},{"type":"inlineCode","text":"\u003clink\u003e"},{"type":"plain","text":" element in "},{"type":"inlineCode","text":"_document.tsx"},{"type":"plain","text":"."}]},{"type":"code","lang":"tsx","text":"export default function Document() {\n  return (\n    \u003cHtml lang=\"en\"\u003e\n      \u003cHead /\u003e\n      \u003clink\n        rel=\"preload\"\n        href=\"/fonts/NotoSerifJP-Regular.woff2\"\n        as=\"font\"\n        type=\"font/woff2\"\n      /\u003e\n      \u003cbody\u003e\n        \u003cMain /\u003e\n        \u003cNextScript /\u003e\n      \u003c/body\u003e\n    \u003c/Html\u003e\n  )\n}"},{"type":"paragraph","children":[{"type":"plain","text":"Then I set the font face in "},{"type":"inlineCode","text":"global.css"},{"type":"plain","text":" and applied the "},{"type":"inlineCode","text":"font-family"},{"type":"plain","text":" to "},{"type":"inlineCode","text":"body"},{"type":"plain","text":"."}]},{"type":"code","lang":"css","text":"@font-face {\n  font-family: 'NotoSerifJP';\n  font-style: normal;\n  font-weight: 400;\n  font-display: optional;\n  src: url(/fonts/NotoSerifJP-Regular.woff2) format(woff2);\n}\n\nhtml,\nbody {\n  font-family: 'NotoSerifJP';\n}"},{"type":"heading","children":[{"type":"plain","text":"Behavior"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"When access either the dev server or the prod environment from the development machine, the font loads successfully. But when access from any other single machine on the world, the font won't load and the app switches back to default sans font."}]},{"type":"paragraph","children":[{"type":"plain","text":"The font file is successfully fetched on either machine, but on the remote machine the fetched font's content becomes the default sans font. I used some online .woff2 preview tool and it clearly shows that the downloaded .woff2 file is the default sans font. Such issue didn't happen on the development machine."}]},{"type":"image","url":"nextjs-app-font-not-loaded-on-remote-machine-issue_1.png","caption":"Font file response on development machine","alt":null},{"type":"image","url":"nextjs-app-font-not-loaded-on-remote-machine-issue_2.png","caption":"Font file response on remote machine","alt":null},{"type":"heading","children":[{"type":"plain","text":"Attempts"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"I tried the configurations shown in "},{"type":"link","text":"this youtube video","url":"https://www.youtube.com/watch?v=L8_98i_bMMA"},{"type":"plain","text":".\n(It was super easy to understand, turns out it was a Vercel's developer's channel.)"}]},{"type":"paragraph","children":[{"type":"plain","text":"I discarded the local .woff2 file and tried "},{"type":"inlineCode","text":"@next/font"},{"type":"plain","text":". Since I was using Tailwindcss, I set the font variable and the "},{"type":"inlineCode","text":"tainwind.config.js"},{"type":"plain","text":" configurations."}]},{"type":"paragraph","children":[{"type":"plain","text":"After above configuration, the latin part of the font started to load on remote machine. Only the Japanese and Chinese parts remain the default sans font."}]},{"type":"heading","children":[{"type":"plain","text":"Root Cause"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"When creating font const using "},{"type":"inlineCode","text":"@next/font"},{"type":"plain","text":", the "},{"type":"inlineCode","text":"display"},{"type":"plain","text":" option is defaulted to "},{"type":"inlineCode","text":"optional"},{"type":"plain","text":", which will switch to fallback font if the loading time is over 100ms."}]},{"type":"paragraph","children":[{"type":"plain","text":"Since I was using "},{"type":"link","text":"Noto Serif JP","url":"https://fonts.google.com/noto/specimen/Noto+Serif+JP?query=noto+se"},{"type":"plain","text":", the Japanese subset is way heavier than the latin set, which makes the Japanese part fallbacks to default font."}]},{"type":"paragraph","children":[{"type":"plain","text":"When I was hosting the .woff2 file instead of using "},{"type":"inlineCode","text":"@next/font"},{"type":"plain","text":", I didn't set the subset rules, hence made the whole font file too big to load, thus on every remote machine the font fallbacks. Only on the development machine, the font was not loaded through http but local disc, which it makes the below 100ms line."}]},{"type":"heading","children":[{"type":"plain","text":"Solution"}],"depth":2},{"type":"paragraph","children":[{"type":"plain","text":"Use "},{"type":"inlineCode","text":"display: swap"},{"type":"plain","text":" to ensure font loading."}]},{"type":"paragraph","children":[{"type":"plain","text":"It causes some "},{"type":"link","text":"FOUT","url":"https://fonts.google.com/knowledge/glossary/fout"},{"type":"plain","text":", but it's a way lesser evil compare to the origin issue."}]},{"type":"heading","children":[{"type":"plain","text":"References"}],"depth":1},{"type":"list","ordered":false,"children":[{"type":"listItem","children":[{"type":"link","text":"@next/font で初回読み込み時にフォントが適用されない","url":"https://www.satoooh.org/blog/next-font-display"}]}]}],"postMetadata":{"id":"nextjs-app-font-not-loaded-on-remote-machine-issue","title":"Next.js App Font Not Loaded on Remote Machine Issue","description":"Debugging note of a source loading issue that never reproduces on the dev machine.","category":"Web Development","language":["en-US"],"tags":[],"publishDate":"2023-06-05","pathname":"nextjs-app-font-not-loaded-on-remote-machine-issue","zhTwLink":null,"filename":"Next.js App Font Not Loaded on Remote Machine Issue (blog)"},"categoryList":{"Life":6,"Game Development":5,"Gaming":12,"League of Legends":8,"Meta":4,"Web Development":4,"HKT48":4,"Programming":3,"Movie":2},"last5posts":[{"id":"a-peek-of-the-world","title":"A Peek of the World","description":"I went to Copenhagen and London for my honeymoon, the first trip to Europe in my life. Some memories keep staying on my mind and I have many thoughts about them.","category":"Life","language":["en-US"],"tags":[],"publishDate":"2024-06-16","pathname":"a-peek-of-the-world","zhTwLink":null,"filename":"A Peek of the World (blog)"},{"id":"godot-essentials","title":"Godot Essentials","description":"The biggest lessons I learned in my first Godot project.","category":"Game Development","language":["en-US"],"tags":[],"publishDate":"2024-04-21","pathname":"godot-essentials","zhTwLink":null,"filename":"Godot Essentials (blog)"},{"id":"4-years-reflection","title":"4 Years Reflection","description":"Another two years of life as a full-time developer has passed. Many things changed and many lessons learned. It's a perfect timing to look back and reflect.","category":"Life","language":["en-US"],"tags":[],"publishDate":"2024-04-08","pathname":"4-years-reflection","zhTwLink":null,"filename":"4 Years Reflection (blog)"},{"id":"improving-greatness","title":"Improving Greatness","description":"Breath of the Wild is one of the most impactful game in last decade. Yet for its successor, Nintendo built an even more polished version on an already magnificent fundamental.","category":"Gaming","language":["en-US"],"tags":[],"publishDate":"2024-03-17","pathname":"improving-greatness","zhTwLink":null,"filename":"Improving Greatness (blog)"},{"id":"s13-recap","title":"S13 Recap","description":"After a three years gap, I'm back to league.","category":"League of Legends","language":["en-US"],"tags":[],"publishDate":"2024-01-23","pathname":"s13-recap","zhTwLink":null,"filename":"S13 Recap (blog)"}]},"__N_SSG":true},"page":"/blog/[pathname]","query":{"pathname":"nextjs-app-font-not-loaded-on-remote-machine-issue"},"buildId":"b2O70Ct3E4Fuh0ajn30AQ","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>